// ============================================
// ESTRUTURA DO PROJETO
// ============================================
/*
infoclin-api/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ article.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ article.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ article.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ article.module.ts
‚îÇ   ‚îî‚îÄ‚îÄ server.ts
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
*/

// ============================================
// 1. package.json
// ============================================
/*
{
  "name": "infoclin-api",
  "version": "1.0.0",
  "description": "API de Artigos de Sa√∫de - InfoClin",
  "main": "dist/server.js",
  "scripts": {
    "dev": "ts-node-dev --respawn --transpile-only src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "@types/express": "^4.17.21",
    "@types/cors": "^2.8.17",
    "@types/node": "^20.10.0",
    "typescript": "^5.3.0",
    "ts-node-dev": "^2.0.0"
  }
}
*/

// ============================================
// 2. tsconfig.json
// ============================================
/*
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node"
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
*/

// ============================================
// 3. .env (criar na raiz do projeto)
// ============================================
/*
PORT=3000
NODE_ENV=development
*/

// ============================================
// 4. src/types/article.types.ts
// ============================================
export interface IArticle {
  id: number;
  titulo: string;
  resumo: string;
  conteudo: string;
  autor: string;
  data: string;
  categoria: string;
  tempo: string;
  imagem?: string;
}

export interface ArticleQueryParams {
  categoria?: string;
  autor?: string;
  search?: string;
}

export interface CreateArticleDTO {
  titulo: string;
  resumo: string;
  conteudo: string;
  autor: string;
  data: string;
  categoria: string;
  tempo: string;
  imagem?: string;
}

export interface UpdateArticleDTO {
  titulo?: string;
  resumo?: string;
  conteudo?: string;
  autor?: string;
  data?: string;
  categoria?: string;
  tempo?: string;
  imagem?: string;
}

// ============================================
// 5. src/services/article.service.ts
// ============================================
import { IArticle, CreateArticleDTO, UpdateArticleDTO, ArticleQueryParams } from '../types/article.types';

export class ArticleService {
  private articles: IArticle[] = [];
  private nextId: number = 1;

  constructor() {
    this.seedArticles();
  }

  // Criar novo artigo
  createArticle(data: CreateArticleDTO): IArticle {
    const newArticle: IArticle = {
      id: this.nextId++,
      ...data
    };

    this.articles.push(newArticle);
    return newArticle;
  }

  // Listar todos os artigos com filtros
  getAllArticles(params?: ArticleQueryParams): IArticle[] {
    let filteredArticles = [...this.articles];

    if (params) {
      // Filtrar por categoria
      if (params.categoria) {
        filteredArticles = filteredArticles.filter(
          article => article.categoria.toLowerCase() === params.categoria?.toLowerCase()
        );
      }

      // Filtrar por autor
      if (params.autor) {
        filteredArticles = filteredArticles.filter(
          article => article.autor.toLowerCase().includes(params.autor?.toLowerCase() || '')
        );
      }

      // Buscar no t√≠tulo e resumo
      if (params.search) {
        const searchLower = params.search.toLowerCase();
        filteredArticles = filteredArticles.filter(
          article =>
            article.titulo.toLowerCase().includes(searchLower) ||
            article.resumo.toLowerCase().includes(searchLower)
        );
      }
    }

    // Ordenar por data (mais recente primeiro)
    return filteredArticles.sort((a, b) => {
      return new Date(b.data).getTime() - new Date(a.data).getTime();
    });
  }

  // Buscar artigo por ID
  getArticleById(id: number): IArticle | null {
    const article = this.articles.find(a => a.id === id);
    return article || null;
  }

  // Atualizar artigo
  updateArticle(id: number, data: UpdateArticleDTO): IArticle | null {
    const index = this.articles.findIndex(a => a.id === id);

    if (index === -1) {
      return null;
    }

    this.articles[index] = {
      ...this.articles[index],
      ...data
    };

    return this.articles[index];
  }

  // Deletar artigo
  deleteArticle(id: number): boolean {
    const index = this.articles.findIndex(a => a.id === id);

    if (index === -1) {
      return false;
    }

    this.articles.splice(index, 1);
    return true;
  }

  // Buscar artigos por categoria
  getArticlesByCategory(categoria: string): IArticle[] {
    return this.articles.filter(
      article => article.categoria.toLowerCase() === categoria.toLowerCase()
    );
  }

  // Contar total de artigos
  countArticles(params?: ArticleQueryParams): number {
    return this.getAllArticles(params).length;
  }

  // Popular com artigos iniciais
  private seedArticles(): void {
    const initialArticles: CreateArticleDTO[] = [
      {
        titulo: "Import√¢ncia da Hidrata√ß√£o",
        resumo: "Descubra como a √°gua √© essencial para o bom funcionamento do corpo humano.",
        conteudo: `
          <p>A hidrata√ß√£o adequada √© fundamental para a manuten√ß√£o da sa√∫de. O corpo humano √© composto por aproximadamente 60% de √°gua, e cada sistema do nosso organismo depende dela para funcionar corretamente.</p>
          
          <p><strong>Benef√≠cios da hidrata√ß√£o adequada:</strong></p>
          <p>‚Ä¢ Regula a temperatura corporal<br>
          ‚Ä¢ Auxilia na digest√£o e absor√ß√£o de nutrientes<br>
          ‚Ä¢ Mant√©m a pele saud√°vel<br>
          ‚Ä¢ Elimina toxinas atrav√©s dos rins<br>
          ‚Ä¢ Melhora o desempenho f√≠sico e mental</p>
          
          <p>A desidrata√ß√£o pode causar fadiga, dores de cabe√ßa, tontura e at√© problemas renais graves. Recomenda-se beber pelo menos 2 litros de √°gua por dia, mas essa quantidade pode variar de acordo com o peso, atividade f√≠sica e clima.</p>
        `,
        autor: "Dra. Maria Santos",
        data: "2024-11-20",
        categoria: "Nutri√ß√£o",
        tempo: "5 min",
        imagem: "https://images.unsplash.com/photo-1560493676-04071c5f467b?w=800"
      },
      {
        titulo: "Exerc√≠cios F√≠sicos Regulares",
        resumo: "Os benef√≠cios da atividade f√≠sica para corpo e mente.",
        conteudo: `
          <p>A pr√°tica regular de exerc√≠cios f√≠sicos √© uma das melhores decis√µes que voc√™ pode tomar pela sua sa√∫de. Os benef√≠cios v√£o muito al√©m da perda de peso e ganho de massa muscular.</p>
          
          <p><strong>Principais benef√≠cios:</strong></p>
          <p>‚Ä¢ Fortalece o sistema cardiovascular<br>
          ‚Ä¢ Reduz o risco de doen√ßas cr√¥nicas<br>
          ‚Ä¢ Melhora a sa√∫de mental e reduz o estresse<br>
          ‚Ä¢ Aumenta a disposi√ß√£o e energia<br>
          ‚Ä¢ Fortalece ossos e m√∫sculos</p>
          
          <p>A Organiza√ß√£o Mundial da Sa√∫de recomenda pelo menos 150 minutos de atividade f√≠sica moderada por semana para adultos.</p>
        `,
        autor: "Dr. Carlos Oliveira",
        data: "2024-11-18",
        categoria: "Atividade F√≠sica",
        tempo: "6 min",
        imagem: "https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=800"
      },
      {
        titulo: "Alimenta√ß√£o Balanceada",
        resumo: "Como uma dieta equilibrada impacta sua qualidade de vida.",
        conteudo: `
          <p>Uma alimenta√ß√£o balanceada √© a base para uma vida saud√°vel. O que colocamos no prato todos os dias tem impacto direto em nossa energia, imunidade e bem-estar geral.</p>
          
          <p><strong>Princ√≠pios de uma alimenta√ß√£o saud√°vel:</strong></p>
          <p>‚Ä¢ Variedade de alimentos naturais<br>
          ‚Ä¢ Consumo adequado de frutas e vegetais<br>
          ‚Ä¢ Prote√≠nas de qualidade<br>
          ‚Ä¢ Carboidratos integrais<br>
          ‚Ä¢ Gorduras saud√°veis</p>
          
          <p>Evite alimentos ultraprocessados e priorize alimentos in natura ou minimamente processados.</p>
        `,
        autor: "Dra. Ana Paula Silva",
        data: "2024-11-15",
        categoria: "Nutri√ß√£o",
        tempo: "7 min",
        imagem: "https://images.unsplash.com/photo-1490645935967-10de6ba17061?w=800"
      },
      {
        titulo: "Qualidade do Sono",
        resumo: "A import√¢ncia de uma boa noite de sono para a sa√∫de.",
        conteudo: `
          <p>O sono de qualidade √© essencial para a recupera√ß√£o f√≠sica e mental. Durante o sono, o corpo realiza processos vitais de repara√ß√£o e consolida√ß√£o de mem√≥rias.</p>
          
          <p><strong>Benef√≠cios de dormir bem:</strong></p>
          <p>‚Ä¢ Fortalece o sistema imunol√≥gico<br>
          ‚Ä¢ Melhora a mem√≥ria e concentra√ß√£o<br>
          ‚Ä¢ Regula o humor e reduz ansiedade<br>
          ‚Ä¢ Auxilia no controle do peso<br>
          ‚Ä¢ Previne doen√ßas card√≠acas</p>
          
          <p>Adultos devem dormir entre 7 a 9 horas por noite. Estabelecer uma rotina regular de sono √© fundamental para a sa√∫de.</p>
        `,
        autor: "Dr. Roberto Mendes",
        data: "2024-11-12",
        categoria: "Bem-estar",
        tempo: "5 min",
        imagem: "https://images.unsplash.com/photo-1511988617509-a57c8a288659?w=800"
      },
      {
        titulo: "Sa√∫de Mental no Trabalho",
        resumo: "Como cuidar da sa√∫de mental no ambiente profissional.",
        conteudo: `
          <p>A sa√∫de mental no trabalho √© t√£o importante quanto a sa√∫de f√≠sica. O estresse ocupacional pode levar a problemas s√©rios como burnout, ansiedade e depress√£o.</p>
          
          <p><strong>Dicas para manter a sa√∫de mental:</strong></p>
          <p>‚Ä¢ Estabele√ßa limites entre trabalho e vida pessoal<br>
          ‚Ä¢ Fa√ßa pausas regulares durante o expediente<br>
          ‚Ä¢ Pratique t√©cnicas de relaxamento<br>
          ‚Ä¢ Mantenha comunica√ß√£o aberta com colegas<br>
          ‚Ä¢ Busque ajuda profissional quando necess√°rio</p>
        `,
        autor: "Dra. Juliana Costa",
        data: "2024-11-10",
        categoria: "Sa√∫de Mental",
        tempo: "6 min",
        imagem: "https://images.unsplash.com/photo-1573497019940-1c28c88b4f3e?w=800"
      },
      {
        titulo: "Preven√ß√£o de Doen√ßas Cardiovasculares",
        resumo: "Medidas essenciais para manter o cora√ß√£o saud√°vel.",
        conteudo: `
          <p>As doen√ßas cardiovasculares s√£o a principal causa de morte no mundo, mas muitas delas podem ser prevenidas com h√°bitos saud√°veis.</p>
          
          <p><strong>Medidas preventivas:</strong></p>
          <p>‚Ä¢ N√£o fume e evite o fumo passivo<br>
          ‚Ä¢ Mantenha uma alimenta√ß√£o saud√°vel<br>
          ‚Ä¢ Pratique exerc√≠cios regularmente<br>
          ‚Ä¢ Controle o estresse<br>
          ‚Ä¢ Fa√ßa check-ups regulares</p>
          
          <p>Controlar press√£o arterial, colesterol e diabetes √© fundamental para prevenir problemas card√≠acos.</p>
        `,
        autor: "Dr. Fernando Almeida",
        data: "2024-11-08",
        categoria: "Preven√ß√£o",
        tempo: "8 min",
        imagem: "https://images.unsplash.com/photo-1628348068343-c6a848d2b6dd?w=800"
      }
    ];

    initialArticles.forEach(article => this.createArticle(article));
    console.log('‚úÖ Artigos iniciais carregados em mem√≥ria!');
  }
}

// ============================================
// 6. src/controllers/article.controller.ts
// ============================================
import { Request, Response } from 'express';
import { ArticleService } from '../services/article.service';
import { CreateArticleDTO, UpdateArticleDTO } from '../types/article.types';

export class ArticleController {
  constructor(private articleService: ArticleService) {}

  // GET /api/articles - Listar todos os artigos
  getAllArticles = (req: Request, res: Response): void => {
    try {
      const { categoria, autor, search } = req.query;

      const articles = this.articleService.getAllArticles({
        categoria: categoria as string,
        autor: autor as string,
        search: search as string
      });

      const total = articles.length;

      res.status(200).json({
        success: true,
        data: articles,
        total
      });
    } catch (error: any) {
      res.status(500).json({
        success: false,
        message: 'Erro ao buscar artigos',
        error: error.message
      });
    }
  };

  // GET /api/articles/:id - Buscar artigo por ID
  getArticleById = (req: Request, res: Response): void => {
    try {
      const id = parseInt(req.params.id);

      if (isNaN(id)) {
        res.status(400).json({
          success: false,
          message: 'ID inv√°lido'
        });
        return;
      }

      const article = this.articleService.getArticleById(id);

      if (!article) {
        res.status(404).json({
          success: false,
          message: 'Artigo n√£o encontrado'
        });
        return;
      }

      res.status(200).json({
        success: true,
        data: article
      });
    } catch (error: any) {
      res.status(500).json({
        success: false,
        message: 'Erro ao buscar artigo',
        error: error.message
      });
    }
  };

  // POST /api/articles - Criar novo artigo
  createArticle = (req: Request, res: Response): void => {
    try {
      const articleData: CreateArticleDTO = req.body;

      // Valida√ß√µes b√°sicas
      if (!articleData.titulo || !articleData.resumo || !articleData.conteudo) {
        res.status(400).json({
          success: false,
          message: 'T√≠tulo, resumo e conte√∫do s√£o obrigat√≥rios'
        });
        return;
      }

      const article = this.articleService.createArticle(articleData);

      res.status(201).json({
        success: true,
        message: 'Artigo criado com sucesso',
        data: article
      });
    } catch (error: any) {
      res.status(400).json({
        success: false,
        message: 'Erro ao criar artigo',
        error: error.message
      });
    }
  };

  // PUT /api/articles/:id - Atualizar artigo
  updateArticle = (req: Request, res: Response): void => {
    try {
      const id = parseInt(req.params.id);
      const updateData: UpdateArticleDTO = req.body;

      if (isNaN(id)) {
        res.status(400).json({
          success: false,
          message: 'ID inv√°lido'
        });
        return;
      }

      const article = this.articleService.updateArticle(id, updateData);

      if (!article) {
        res.status(404).json({
          success: false,
          message: 'Artigo n√£o encontrado'
        });
        return;
      }

      res.status(200).json({
        success: true,
        message: 'Artigo atualizado com sucesso',
        data: article
      });
    } catch (error: any) {
      res.status(400).json({
        success: false,
        message: 'Erro ao atualizar artigo',
        error: error.message
      });
    }
  };

  // DELETE /api/articles/:id - Deletar artigo
  deleteArticle = (req: Request, res: Response): void => {
    try {
      const id = parseInt(req.params.id);

      if (isNaN(id)) {
        res.status(400).json({
          success: false,
          message: 'ID inv√°lido'
        });
        return;
      }

      const deleted = this.articleService.deleteArticle(id);

      if (!deleted) {
        res.status(404).json({
          success: false,
          message: 'Artigo n√£o encontrado'
        });
        return;
      }

      res.status(200).json({
        success: true,
        message: 'Artigo deletado com sucesso'
      });
    } catch (error: any) {
      res.status(500).json({
        success: false,
        message: 'Erro ao deletar artigo',
        error: error.message
      });
    }
  };

  // GET /api/articles/category/:categoria - Buscar por categoria
  getArticlesByCategory = (req: Request, res: Response): void => {
    try {
      const { categoria } = req.params;
      const articles = this.articleService.getArticlesByCategory(categoria);

      res.status(200).json({
        success: true,
        data: articles,
        total: articles.length
      });
    } catch (error: any) {
      res.status(500).json({
        success: false,
        message: 'Erro ao buscar artigos por categoria',
        error: error.message
      });
    }
  };
}

// ============================================
// 7. src/modules/article.module.ts
// ============================================
import { Router } from 'express';
import { ArticleService } from '../services/article.service';
import { ArticleController } from '../controllers/article.controller';

export class ArticleModule {
  public router: Router;
  private articleService: ArticleService;
  private articleController: ArticleController;

  constructor() {
    this.router = Router();
    this.articleService = new ArticleService();
    this.articleController = new ArticleController(this.articleService);
    this.initializeRoutes();
  }

  private initializeRoutes(): void {
    // Listar todos os artigos (com filtros opcionais)
    // Query params: ?categoria=Nutri√ß√£o&autor=Maria&search=hidrata√ß√£o
    this.router.get('/', this.articleController.getAllArticles);

    // Buscar artigos por categoria
    this.router.get('/category/:categoria', this.articleController.getArticlesByCategory);

    // Buscar artigo por ID
    this.router.get('/:id', this.articleController.getArticleById);

    // Criar novo artigo
    this.router.post('/', this.articleController.createArticle);

    // Atualizar artigo
    this.router.put('/:id', this.articleController.updateArticle);

    // Deletar artigo
    this.router.delete('/:id', this.articleController.deleteArticle);
  }

  public getRouter(): Router {
    return this.router;
  }
}

// ============================================
// 8. src/server.ts
// ============================================
import express, { Application, Request, Response } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { ArticleModule } from './modules/article.module';

dotenv.config();

class Server {
  private app: Application;
  private port: number;

  constructor() {
    this.app = express();
    this.port = parseInt(process.env.PORT || '3000');
    
    this.configureMiddlewares();
    this.configureRoutes();
  }

  private configureMiddlewares(): void {
    // CORS - permite requisi√ß√µes do frontend
    this.app.use(cors());
    
    // Parse JSON
    this.app.use(express.json());
    
    // Parse URL-encoded
    this.app.use(express.urlencoded({ extended: true }));

    // Log de requisi√ß√µes
    this.app.use((req, res, next) => {
      console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
      next();
    });
  }

  private configureRoutes(): void {
    // Rota de health check
    this.app.get('/', (req: Request, res: Response) => {
      res.json({
        message: 'üè• InfoClin API - Sistema de Artigos de Sa√∫de',
        version: '1.0.0',
        status: 'online',
        endpoints: {
          articles: '/api/articles',
          health: '/',
          docs: '/api/articles (GET, POST, PUT, DELETE)'
        }
      });
    });

    // M√≥dulo de artigos
    const articleModule = new ArticleModule();
    this.app.use('/api/articles', articleModule.getRouter());

    // Rota n√£o encontrada
    this.app.use('*', (req: Request, res: Response) => {
      res.status(404).json({
        success: false,
        message: 'Rota n√£o encontrada',
        availableRoutes: [
          'GET /',
          'GET /api/articles',
          'GET /api/articles/:id',
          'GET /api/articles/category/:categoria',
          'POST /api/articles',
          'PUT /api/articles/:id',
          'DELETE /api/articles/:id'
        ]
      });
    });
  }

  public start(): void {
    this.app.listen(this.port, () => {
      console.log('===========================================');
      console.log('üè• InfoClin API');
      console.log('===========================================');
      console.log(`‚úÖ Servidor rodando na porta ${this.port}`);
      console.log(`üåê http://localhost:${this.port}`);
      console.log(`üìã API: http://localhost:${this.port}/api/articles`);
      console.log('===========================================');
    });
  }
}

// Inicializar servidor
const server = new Server();
server.start();

// ============================================
// COMANDOS PARA RODAR O PROJETO
// ============================================
/*

1. Criar o projeto:
   mkdir infoclin-api
   cd infoclin-api

2. Inicializar package.json:
   npm init -y

3. Instalar depend√™ncias:
   npm install express cors dotenv
   npm install -D typescript @types/express @types/cors @types/node ts-node-dev

4. Copiar os arquivos acima para suas respectivas pastas

5. Rodar em desenvolvimento:
   npm run dev

6. Testar a API:
   GET    http://localhost:3000/api/articles
   GET    http://localhost:3000/api/articles/1
   GET    http://localhost:3000/api/articles/category/Nutri√ß√£o
   POST   http://localhost:3000/api/articles
   PUT    http://localhost:3000/api/articles/1
   DELETE http://localhost:3000/api/articles/1

*/
